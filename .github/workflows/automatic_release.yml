name: 'Automatic Release'

on:
    push:
        tags:
            - 'v*'
        branches: ['main']

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: 'Checkout'
              uses: actions/checkout@v4
            - name: 'Binary build'
              run: 'cd output && bash build_release.sh'
            - name: 'Upload binaries'
              uses: actions/upload-artifact@v3
              with:
                  path: output/release

    upload:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: 'Checkout'
              uses: actions/checkout@v4
            - name: 'Download built binaries'
              uses: actions/download-artifact@v3
              with:
                  path: 'output/release'
            - name: 'Pack binaries'
              run: 'cd output/release && tar -czf release.tar.gz *'
            - name: 'Publish Release'
              uses: marvinpinto/action-automatic-releases@v1.2.1
              with:
                repo_token: ${{ secrets.API_TOKEN_GITHUB }}
                automatic_release_tag: "latest"
                files: 'output/release/release.tar.gz'
                title: 'Build ${{ github.ref }}'
